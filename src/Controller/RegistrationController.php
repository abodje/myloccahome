<?php

namespace App\Controller;

use App\Entity\Organization;
use App\Entity\User;
use App\Entity\Plan;
use App\Repository\PlanRepository;
use App\Service\SubscriptionService;
use App\Service\DemoEnvironmentService;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\PasswordHasher\Hasher\UserPasswordHasherInterface;
use Symfony\Component\Routing\Attribute\Route;
use Symfony\Component\String\Slugger\SluggerInterface;

#[Route('/inscription')]
class RegistrationController extends AbstractController
{
    /**
     * Page de choix de plan
     */
    #[Route('/plans', name: 'app_registration_plans', methods: ['GET'])]
    public function plans(PlanRepository $planRepository): Response
    {
        $plans = $planRepository->findActivePlans();

        return $this->render('registration/plans.html.twig', [
            'plans' => $plans,
        ]);
    }

    /**
     * Formulaire d'inscription
     */
    #[Route('/inscription/{planSlug}', name: 'app_registration_register', methods: ['GET', 'POST'])]
    public function register(
        string $planSlug,
        Request $request,
        PlanRepository $planRepository,
        EntityManagerInterface $entityManager,
        UserPasswordHasherInterface $passwordHasher,
        SluggerInterface $slugger,
        SubscriptionService $subscriptionService,
        DemoEnvironmentService $demoEnvironmentService
    ): Response {
        $plan = $planRepository->findBySlug($planSlug);

        if (!$plan) {
            $this->addFlash('error', 'Plan d\'abonnement introuvable.');
            return $this->redirectToRoute('app_registration_plans');
        }

        if ($request->isMethod('POST')) {
            try {
                // Donn√©es de l'organisation
                $orgName = $request->request->get('organization_name');
                $orgEmail = $request->request->get('organization_email');
                $orgPhone = $request->request->get('organization_phone');

                // Donn√©es de l'utilisateur
                $userFirstName = $request->request->get('first_name');
                $userLastName = $request->request->get('last_name');
                $userEmail = $request->request->get('email');
                $userPassword = $request->request->get('password');

                // Cycle de facturation
                $billingCycle = $request->request->get('billing_cycle', 'MONTHLY');

                // Validation des donn√©es
                if (empty($orgName) || empty($userEmail) || empty($userPassword)) {
                    $this->addFlash('error', 'Veuillez remplir tous les champs obligatoires.');
                    return $this->render('registration/register.html.twig', ['plan' => $plan]);
                }

                // V√©rifier si l'email existe d√©j√†
                $existingUser = $entityManager->getRepository(User::class)->findOneBy(['email' => $userEmail]);
                if ($existingUser) {
                    $this->addFlash('error', 'Cet email est d√©j√† utilis√©. Si vous avez d√©j√† un compte, veuillez vous connecter. Si votre inscription pr√©c√©dente a √©chou√©, veuillez contacter le support ou utiliser un autre email.');
                    return $this->render('registration/register.html.twig', ['plan' => $plan]);
                }

                // V√©rifier aussi si l'email existe dans la table Tenant pour √©viter les conflits futurs
                $existingTenant = $entityManager->getRepository(\App\Entity\Tenant::class)->findOneBy(['email' => $userEmail]);
                if ($existingTenant) {
                    $this->addFlash('warning', 'Cet email existe d√©j√† dans notre syst√®me. Veuillez utiliser un autre email.');
                    return $this->render('registration/register.html.twig', ['plan' => $plan]);
                }

                // Cr√©er l'organisation
                $organization = new Organization();
                $organization->setName($orgName);
                $organization->setSlug($slugger->slug($orgName)->lower());
                $organization->setEmail($orgEmail);
                $organization->setPhone($orgPhone);
                $organization->setStatus('TRIAL'); // Commence en p√©riode d'essai
                $organization->setCreatedAt(new \DateTime());
                $organization->setIsActive(true);

                // Copier les fonctionnalit√©s du plan vers l'organisation
                $organization->setFeatures($plan->getFeatures());

                // D√©finir les limites bas√©es sur le plan
                $organization->setSetting('max_properties', $plan->getMaxProperties());
                $organization->setSetting('max_tenants', $plan->getMaxTenants());
                $organization->setSetting('max_users', $plan->getMaxUsers());
                $organization->setSetting('max_documents', $plan->getMaxDocuments());

                $entityManager->persist($organization);

                // Cr√©er la soci√©t√© par d√©faut (si√®ge social)
                $company = new \App\Entity\Company();
                $company->setName($orgName);
                $company->setLegalName($orgName);
                $company->setOrganization($organization);
                $company->setEmail($orgEmail);
                $company->setPhone($orgPhone);
                $company->setStatus('ACTIVE');
                $company->setIsHeadquarter(true); // C'est le si√®ge social
                $company->setCreatedAt(new \DateTime());

                $entityManager->persist($company);

                // Cr√©er l'utilisateur administrateur
                $user = new User();
                $user->setEmail($userEmail);
                $user->setFirstName($userFirstName ?? 'Admin');
                $user->setLastName($userLastName ?? 'Admin');
                $user->setRoles(['ROLE_ADMIN']);
                $user->setOrganization($organization);

                $hashedPassword = $passwordHasher->hashPassword($user, $userPassword);
                $user->setPassword($hashedPassword);

                $entityManager->persist($user);

                // Cr√©er l'abonnement
                $subscription = $subscriptionService->createSubscription(
                    $organization,
                    $plan,
                    $billingCycle
                );

                $entityManager->flush();

                // Cr√©er l'environnement de d√©mo automatiquement (dans un try-catch s√©par√©)
                try {
                    $demoResult = $demoEnvironmentService->createDemoEnvironment($user);

                    if ($demoResult['success']) {
                        $this->addFlash('success', 'üéâ Votre compte et environnement de d√©mo ont √©t√© cr√©√©s avec succ√®s !');
                        $this->addFlash('info', "üåê Votre environnement de d√©mo : {$demoResult['demo_url']}");
                        $this->addFlash('info', "üìä Donn√©es de d√©mo cr√©√©es : {$demoResult['demo_data']['properties']} propri√©t√©s, {$demoResult['demo_data']['tenants']} locataires, {$demoResult['demo_data']['leases']} baux, {$demoResult['demo_data']['payments']} paiements");
                    } else {
                        $this->addFlash('warning', '‚ö†Ô∏è Compte cr√©√© mais erreur lors de la cr√©ation de l\'environnement de d√©mo : ' . $demoResult['error']);
                    }
                } catch (\Exception $demoException) {
                    // Log l'erreur mais ne pas faire √©chouer l'inscription
                    error_log('Erreur cr√©ation environnement d√©mo: ' . $demoException->getMessage());
                    $this->addFlash('warning', '‚ö†Ô∏è Compte cr√©√© avec succ√®s, mais erreur lors de la cr√©ation de l\'environnement de d√©mo. Vous pourrez le cr√©er manuellement plus tard.');
                }

                // Si plan gratuit (Freemium), activer directement
                if ($plan->getSlug() === 'freemium' || (float)$plan->getMonthlyPrice() == 0) {
                    $subscriptionService->activateSubscription($subscription);
                    $entityManager->flush();

                    $this->addFlash('success', 'üéâ Votre compte a √©t√© cr√©√© avec succ√®s ! Connectez-vous pour commencer.');
                    return $this->redirectToRoute('app_login');
                }

                // Pour les plans payants, rediriger vers la page de paiement
                return $this->redirectToRoute('app_registration_payment', [
                    'subscriptionId' => $subscription->getId()
                ]);

            } catch (\Exception $e) {
                // Log l'erreur compl√®te pour le debug
                error_log('Erreur inscription: ' . $e->getMessage());
                error_log('Stack trace: ' . $e->getTraceAsString());

                $this->addFlash('error', 'Erreur lors de l\'inscription : ' . $e->getMessage());

                return $this->render('registration/register.html.twig', [
                    'plan' => $plan,
                ]);
            }
        }

        return $this->render('registration/register.html.twig', [
            'plan' => $plan,
        ]);
    }

    /**
     * Page de paiement de l'abonnement
     */
    #[Route('/paiement/{subscriptionId}', name: 'app_registration_payment', methods: ['GET', 'POST'])]
    public function payment(
        int $subscriptionId,
        Request $request,
        EntityManagerInterface $entityManager
    ): Response {
        $subscription = $entityManager->getRepository(\App\Entity\Subscription::class)->find($subscriptionId);

        if (!$subscription) {
            $this->addFlash('error', 'Abonnement introuvable.');
            return $this->redirectToRoute('app_registration_plans');
        }

        if ($request->isMethod('POST')) {
            // TODO: Int√©grer le paiement CinetPay pour l'abonnement
            // Pour l'instant, on active directement (mode d√©veloppement)

            $subscription->activate();
            $subscription->getOrganization()->setActiveSubscription($subscription);
            $subscription->getOrganization()->setStatus('ACTIVE');

            $entityManager->flush();

            $this->addFlash('success', 'Votre abonnement a √©t√© activ√© avec succ√®s ! Bienvenue sur MYLOCCA.');
            return $this->redirectToRoute('app_login');
        }

        return $this->render('registration/payment.html.twig', [
            'subscription' => $subscription,
            'plan' => $subscription->getPlan(),
            'organization' => $subscription->getOrganization(),
        ]);
    }
}

