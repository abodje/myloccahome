<?php

namespace App\Service;

use Psr\Log\LoggerInterface;
use Symfony\Component\HttpClient\HttpClient;
use Symfony\Contracts\HttpClient\HttpClientInterface;

/**
 * Service pour g√©rer les API cPanel (cr√©ation sous-domaines, bases de donn√©es, etc.)
 */
class CpanelApiService
{
    private HttpClientInterface $client;
    private string $cpanelHost;
    private string $cpanelUsername;
    private string $cpanelToken;
    private int $cpanelPort;

    public function __construct(
        private LoggerInterface $logger,
        string $cpanelHost,
        string $cpanelUsername,
        string $cpanelToken,
        int $cpanelPort = 2083
    ) {
        $this->cpanelHost = $cpanelHost;
        $this->cpanelUsername = $cpanelUsername;
        $this->cpanelToken = $cpanelToken;
        $this->cpanelPort = $cpanelPort;

        $this->client = HttpClient::create([
            'verify_peer' => true,
            'verify_host' => true,
            'headers' => [
                'Authorization' => 'cpanel ' . $cpanelUsername . ':' . $cpanelToken,
            ],
        ]);
    }

    /**
     * Cr√©e un sous-domaine
     */
    public function createSubdomain(string $subdomain, string $domain, string $rootDir): array
    {
        try {
            $this->logger->info("üåê Cr√©ation du sous-domaine: {$subdomain}.{$domain}");

            $response = $this->client->request('GET', $this->buildUrl('SubDomain', 'addsubdomain'), [
                'query' => [
                    'domain' => $subdomain,
                    'rootdomain' => $domain,
                    'dir' => $rootDir,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Sous-domaine cr√©√©: {$subdomain}.{$domain}");
                return ['success' => true, 'data' => $data];
            }

            $this->logger->error("‚ùå √âchec cr√©ation sous-domaine", ['response' => $data]);
            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur cr√©ation sous-domaine: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Supprime un sous-domaine
     */
    public function deleteSubdomain(string $subdomain, string $domain): array
    {
        try {
            $this->logger->info("üóëÔ∏è  Suppression du sous-domaine: {$subdomain}.{$domain}");

            $response = $this->client->request('GET', $this->buildUrl('SubDomain', 'delsubdomain'), [
                'query' => [
                    'domain' => "{$subdomain}.{$domain}",
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Sous-domaine supprim√©");
                return ['success' => true];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur suppression sous-domaine: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Cr√©e une base de donn√©es MySQL
     */
    public function createDatabase(string $databaseName): array
    {
        try {
            $this->logger->info("üíæ Cr√©ation de la base de donn√©es: {$databaseName}");

            $response = $this->client->request('GET', $this->buildUrl('Mysql', 'create_database'), [
                'query' => [
                    'name' => $databaseName,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Base de donn√©es cr√©√©e: {$this->cpanelUsername}_{$databaseName}");
                return ['success' => true, 'database' => "{$this->cpanelUsername}_{$databaseName}"];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur cr√©ation BDD: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Cr√©e un utilisateur MySQL
     */
    public function createDatabaseUser(string $username, string $password): array
    {
        try {
            $this->logger->info("üë§ Cr√©ation de l'utilisateur MySQL: {$username}");

            $response = $this->client->request('GET', $this->buildUrl('Mysql', 'create_user'), [
                'query' => [
                    'name' => $username,
                    'password' => $password,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Utilisateur MySQL cr√©√©: {$this->cpanelUsername}_{$username}");
                return ['success' => true, 'user' => "{$this->cpanelUsername}_{$username}"];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur cr√©ation utilisateur MySQL: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Associe un utilisateur √† une base de donn√©es avec tous les privil√®ges
     */
    public function setDatabasePrivileges(string $username, string $databaseName): array
    {
        try {
            $this->logger->info("üîê Attribution des privil√®ges: {$username} -> {$databaseName}");

            $fullUsername = "{$this->cpanelUsername}_{$username}";
            $fullDatabase = "{$this->cpanelUsername}_{$databaseName}";

            $response = $this->client->request('GET', $this->buildUrl('Mysql', 'set_privileges_on_database'), [
                'query' => [
                    'user' => $fullUsername,
                    'database' => $fullDatabase,
                    'privileges' => 'ALL PRIVILEGES',
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Privil√®ges attribu√©s");
                return ['success' => true];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur attribution privil√®ges: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Supprime une base de donn√©es
     */
    public function deleteDatabase(string $databaseName): array
    {
        try {
            $this->logger->info("üóëÔ∏è  Suppression de la base de donn√©es: {$databaseName}");

            $fullDatabase = "{$this->cpanelUsername}_{$databaseName}";

            $response = $this->client->request('GET', $this->buildUrl('Mysql', 'delete_database'), [
                'query' => [
                    'name' => $fullDatabase,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Base de donn√©es supprim√©e");
                return ['success' => true];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur suppression BDD: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Supprime un utilisateur MySQL
     */
    public function deleteDatabaseUser(string $username): array
    {
        try {
            $this->logger->info("üóëÔ∏è  Suppression de l'utilisateur MySQL: {$username}");

            $fullUsername = "{$this->cpanelUsername}_{$username}";

            $response = $this->client->request('GET', $this->buildUrl('Mysql', 'delete_user'), [
                'query' => [
                    'name' => $fullUsername,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['status']) && $data['status'] == 1) {
                $this->logger->info("‚úÖ Utilisateur MySQL supprim√©");
                return ['success' => true];
            }

            return ['success' => false, 'error' => $data['errors'][0] ?? 'Unknown error'];

        } catch (\Exception $e) {
            $this->logger->error("‚ùå Erreur suppression utilisateur MySQL: " . $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Construit l'URL de l'API cPanel
     */
    private function buildUrl(string $module, string $function): string
    {
        return sprintf(
            'https://%s:%d/execute/%s/%s',
            $this->cpanelHost,
            $this->cpanelPort,
            $module,
            $function
        );
    }

    /**
     * Cr√©e un environnement de d√©mo complet
     */
    public function createDemoEnvironment(string $demoId): array
    {
        $results = [
            'success' => false,
            'subdomain' => null,
            'database' => null,
            'db_user' => null,
            'db_password' => null,
            'errors' => []
        ];

        // G√©n√©rer les noms
        $subdomain = "demo-{$demoId}";
        $domain = "lokapro.tech"; // √Ä configurer
        $rootDir = "/home/{$this->cpanelUsername}/demos/{$subdomain}";
        $dbName = "demo_{$demoId}";
        $dbUser = "demo_{$demoId}";
        $dbPassword = bin2hex(random_bytes(16)); // Mot de passe al√©atoire s√©curis√©

        // 1. Cr√©er le sous-domaine
        $subdomainResult = $this->createSubdomain($subdomain, $domain, $rootDir);
        if (!$subdomainResult['success']) {
            $results['errors'][] = "Sous-domaine: " . $subdomainResult['error'];
            return $results;
        }
        $results['subdomain'] = "{$subdomain}.{$domain}";

        // 2. Cr√©er la base de donn√©es
        $dbResult = $this->createDatabase($dbName);
        if (!$dbResult['success']) {
            $results['errors'][] = "Base de donn√©es: " . $dbResult['error'];
            $this->deleteSubdomain($subdomain, $domain); // Rollback
            return $results;
        }
        $results['database'] = $dbResult['database'];

        // 3. Cr√©er l'utilisateur
        $userResult = $this->createDatabaseUser($dbUser, $dbPassword);
        if (!$userResult['success']) {
            $results['errors'][] = "Utilisateur BDD: " . $userResult['error'];
            $this->deleteDatabase($dbName); // Rollback
            $this->deleteSubdomain($subdomain, $domain);
            return $results;
        }
        $results['db_user'] = $userResult['user'];
        $results['db_password'] = $dbPassword;

        // 4. Attribuer les privil√®ges
        $privResult = $this->setDatabasePrivileges($dbUser, $dbName);
        if (!$privResult['success']) {
            $results['errors'][] = "Privil√®ges: " . $privResult['error'];
            $this->deleteDatabaseUser($dbUser); // Rollback
            $this->deleteDatabase($dbName);
            $this->deleteSubdomain($subdomain, $domain);
            return $results;
        }

        $results['success'] = true;
        $this->logger->info("üéâ Environnement de d√©mo cr√©√© avec succ√®s", $results);

        return $results;
    }

    /**
     * Supprime un environnement de d√©mo complet
     */
    public function deleteDemoEnvironment(string $demoId): array
    {
        $subdomain = "demo-{$demoId}";
        $domain = "lokapro.tech";
        $dbName = "demo_{$demoId}";
        $dbUser = "demo_{$demoId}";

        $errors = [];

        // Supprimer l'utilisateur MySQL
        $userResult = $this->deleteDatabaseUser($dbUser);
        if (!$userResult['success']) {
            $errors[] = "Utilisateur: " . $userResult['error'];
        }

        // Supprimer la base de donn√©es
        $dbResult = $this->deleteDatabase($dbName);
        if (!$dbResult['success']) {
            $errors[] = "Base de donn√©es: " . $dbResult['error'];
        }

        // Supprimer le sous-domaine
        $subdomainResult = $this->deleteSubdomain($subdomain, $domain);
        if (!$subdomainResult['success']) {
            $errors[] = "Sous-domaine: " . $subdomainResult['error'];
        }

        return [
            'success' => empty($errors),
            'errors' => $errors
        ];
    }
}
