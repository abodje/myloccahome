# üè¢ Extension du Syst√®me Company √† Toute l'Application

## ‚úÖ TRAVAIL EFFECTU√â

### **1. Entit√© Company Cr√©√©e**
- ‚úÖ `src/Entity/Company.php` (458 lignes)
- ‚úÖ `src/Repository/CompanyRepository.php`
- Relations compl√®tes avec Organization, Properties, Managers, Tenants, Leases

### **2. Migration SQL Cr√©√©e**
- ‚úÖ `migrations/Version20251013100000.php`
- Cr√©e la table `company`
- Ajoute `company_id` √† toutes les entit√©s principales
- Ajoute `organization_id` aux entit√©s qui ne l'ont pas
- Cr√©e tous les index et contraintes FK

### **3. Event Subscriber Cr√©√©**
- ‚úÖ `src/EventSubscriber/CompanyFilterSubscriber.php`
- D√©finit automatiquement `organization` et `company` lors de la cr√©ation d'entit√©s
- Filtre intelligent selon le r√¥le de l'utilisateur

### **4. Entit√©s Modifi√©es**
- ‚úÖ `src/Entity/Property.php` - Ajout relations Organization + Company
- ‚úÖ `src/Controller/RegistrationController.php` - Cr√©ation auto d'une Company au signup

### **5. Documentation Cr√©√©e**
- ‚úÖ `STRUCTURE_ORGANIZATION_COMPANY.md` - Explication compl√®te du syst√®me
- ‚úÖ `EXTENSION_COMPANY_COMPLETE.md` (ce fichier)

---

## üîÑ TRAVAIL RESTANT √Ä FAIRE

### **Entit√©s √† Modifier** (Ajouter Organization + Company)

#### **Priorit√© HAUTE** (Donn√©es principales)

**1. src/Entity/Tenant.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class, inversedBy: 'tenants')]
#[ORM\JoinColumn(nullable: false)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class, inversedBy: 'tenants')]
#[ORM\JoinColumn(nullable: true)]
private ?Company $company = null;

// + Getters/Setters
```

**2. src/Entity/Lease.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class, inversedBy: 'leases')]
#[ORM\JoinColumn(nullable: false)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class, inversedBy: 'leases')]
#[ORM\JoinColumn(nullable: true)]
private ?Company $company = null;

// + Getters/Setters
```

**3. src/Entity/Payment.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class, inversedBy: 'payments')]
#[ORM\JoinColumn(nullable: false)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class)]
#[ORM\JoinColumn(nullable: true)]
private ?Company $company = null;

// + Getters/Setters
```

**4. src/Entity/User.php**
```php
// D√âJ√Ä A organization, ajouter company

#[ORM\ManyToOne(targetEntity: Company::class, inversedBy: 'managers')]
#[ORM\JoinColumn(nullable: true)]
private ?Company $company = null;

public function getCompany(): ?Company { return $this->company; }
public function setCompany(?Company $company): static { 
    $this->company = $company; 
    return $this;
}
```

#### **Priorit√© MOYENNE** (Donn√©es secondaires)

**5. src/Entity/Expense.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class)]
private ?Company $company = null;
```

**6. src/Entity/MaintenanceRequest.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class)]
private ?Company $company = null;
```

**7. src/Entity/Document.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class)]
private ?Company $company = null;
```

**8. src/Entity/AccountingEntry.php**
```php
#[ORM\ManyToOne(targetEntity: Organization::class)]
private ?Organization $organization = null;

#[ORM\ManyToOne(targetEntity: Company::class)]
private ?Company $company = null;
```

#### **Priorit√© BASSE** (Entit√©s de r√©f√©rence)

**9. src/Entity/Organization.php**
```php
#[ORM\OneToMany(targetEntity: Company::class, mappedBy: 'organization')]
private Collection $companies;

public function getCompanies(): Collection { return $this->companies; }
// Dans __construct(): $this->companies = new ArrayCollection();
```

---

### **Controllers √† Cr√©er/Modifier**

#### **NOUVEAU : CompanyController**
```
src/Controller/CompanyController.php

Routes:
- /societes (liste)
- /societes/nouveau (cr√©er)
- /societes/{id} (voir)
- /societes/{id}/modifier (√©diter)
- /societes/{id}/supprimer (supprimer)
```

#### **√Ä MODIFIER : Controllers Existants**

**PropertyController** :
- Filtrer par organization automatiquement
- Permettre s√©lection de company si ADMIN
- Forcer company de l'user si MANAGER

**TenantController** :
- Filtrer par organization + company selon r√¥le

**LeaseController** :
- Filtrer par organization + company selon r√¥le

**PaymentController** :
- Filtrer par organization + company selon r√¥le

**DashboardController** :
- Afficher stats par organization (ADMIN)
- Afficher stats par company (MANAGER)

---

### **Repositories √† Modifier**

Ajouter des m√©thodes de filtrage par Company dans :
- PropertyRepository
- TenantRepository
- LeaseRepository
- PaymentRepository
- ExpenseRepository
- MaintenanceRequestRepository
- DocumentRepository
- AccountingEntryRepository

**Exemple pour PropertyRepository** :
```php
public function findByCompany(Company $company): array
{
    return $this->createQueryBuilder('p')
        ->where('p.company = :company')
        ->setParameter('company', $company)
        ->orderBy('p.address', 'ASC')
        ->getQuery()
        ->getResult();
}

public function findByOrganization(Organization $organization): array
{
    return $this->createQueryBuilder('p')
        ->where('p.organization = :organization')
        ->setParameter('organization', $organization)
        ->orderBy('p.address', 'ASC')
        ->getQuery()
        ->getResult();
}
```

---

### **Forms √† Cr√©er**

**CompanyType.php** :
```php
namespace App\Form;

use App\Entity\Company;
use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\Extension\Core\Type\CheckboxType;
use Symfony\Component\Form\Extension\Core\Type\EmailType;
use Symfony\Component\Form\Extension\Core\Type\TextareaType;
use Symfony\Component\Form\Extension\Core\Type\TextType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\OptionsResolver\OptionsResolver;

class CompanyType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options): void
    {
        $builder
            ->add('name', TextType::class, [
                'label' => 'Nom de la soci√©t√©',
                'required' => true,
            ])
            ->add('legalName', TextType::class, [
                'label' => 'Raison sociale',
                'required' => false,
            ])
            ->add('registrationNumber', TextType::class, [
                'label' => 'SIRET/SIREN',
                'required' => false,
            ])
            ->add('taxNumber', TextType::class, [
                'label' => 'Num√©ro de TVA',
                'required' => false,
            ])
            ->add('address', TextType::class, [
                'label' => 'Adresse',
                'required' => false,
            ])
            ->add('city', TextType::class, [
                'label' => 'Ville',
                'required' => false,
            ])
            ->add('postalCode', TextType::class, [
                'label' => 'Code postal',
                'required' => false,
            ])
            ->add('phone', TextType::class, [
                'label' => 'T√©l√©phone',
                'required' => false,
            ])
            ->add('email', EmailType::class, [
                'label' => 'Email',
                'required' => false,
            ])
            ->add('website', TextType::class, [
                'label' => 'Site web',
                'required' => false,
            ])
            ->add('description', TextareaType::class, [
                'label' => 'Description',
                'required' => false,
            ])
            ->add('isHeadquarter', CheckboxType::class, [
                'label' => 'Si√®ge social ?',
                'required' => false,
            ]);
    }

    public function configureOptions(OptionsResolver $resolver): void
    {
        $resolver->setDefaults([
            'data_class' => Company::class,
        ]);
    }
}
```

---

### **Templates √† Cr√©er**

**templates/company/** :
- `index.html.twig` (Liste des soci√©t√©s)
- `new.html.twig` (Cr√©er une soci√©t√©)
- `show.html.twig` (D√©tails d'une soci√©t√©)
- `edit.html.twig` (Modifier une soci√©t√©)
- `_form.html.twig` (Formulaire r√©utilisable)

---

### **MenuService √† Modifier**

Ajouter un menu "Soci√©t√©s" dans la section Administration :

```php
'companies' => [
    'label' => 'Soci√©t√©s',
    'icon' => 'bi-building-gear',
    'route' => 'app_company_index',
    'roles' => ['ROLE_ADMIN'],
    'order' => 102,
],
```

---

### **Services √† Cr√©er**

**CompanyService.php** :
```php
namespace App\Service;

use App\Entity\Company;
use App\Entity\Organization;
use Doctrine\ORM\EntityManagerInterface;

class CompanyService
{
    public function __construct(
        private EntityManagerInterface $entityManager
    ) {
    }

    /**
     * Cr√©e une soci√©t√© par d√©faut pour une organization
     */
    public function createDefaultCompany(Organization $organization): Company
    {
        $company = new Company();
        $company->setName($organization->getName());
        $company->setOrganization($organization);
        $company->setEmail($organization->getEmail());
        $company->setPhone($organization->getPhone());
        $company->setStatus('ACTIVE');
        $company->setIsHeadquarter(true);
        $company->setCreatedAt(new \DateTime());

        $this->entityManager->persist($company);
        $this->entityManager->flush();

        return $company;
    }

    /**
     * V√©rifie si un gestionnaire peut acc√©der √† une soci√©t√©
     */
    public function canManagerAccessCompany(User $manager, Company $company): bool
    {
        // Admin peut acc√©der √† toutes les soci√©t√©s de son organization
        if ($manager->hasRole('ROLE_ADMIN')) {
            return $company->getOrganization() === $manager->getOrganization();
        }

        // Manager peut acc√©der uniquement √† SA soci√©t√©
        if ($manager->hasRole('ROLE_MANAGER')) {
            return $company === $manager->getCompany();
        }

        return false;
    }
}
```

---

## üìä Impact sur l'Application

### **AVANT (Sans Company)**
```
Organization
  ‚îú‚îÄ‚îÄ Properties (m√©lang√©es)
  ‚îú‚îÄ‚îÄ Tenants (m√©lang√©s)
  ‚îú‚îÄ‚îÄ Managers (tous voient tout)
  ‚îî‚îÄ‚îÄ Pas de s√©paration
```

### **APR√àS (Avec Company)**
```
Organization
  ‚îú‚îÄ‚îÄ Company 1 (Agence Paris)
  ‚îÇ    ‚îú‚îÄ‚îÄ Manager 1
  ‚îÇ    ‚îú‚îÄ‚îÄ Properties Paris
  ‚îÇ    ‚îî‚îÄ‚îÄ Tenants Paris
  ‚îÇ
  ‚îî‚îÄ‚îÄ Company 2 (Agence Lyon)
       ‚îú‚îÄ‚îÄ Manager 2
       ‚îú‚îÄ‚îÄ Properties Lyon
       ‚îî‚îÄ‚îÄ Tenants Lyon

Admin voit: TOUT
Manager 1 voit: Agence Paris uniquement
Manager 2 voit: Agence Lyon uniquement
```

---

## üöÄ √âtapes de D√©ploiement

### **Phase 1 : Base de donn√©es** ‚úÖ
1. ‚úÖ Cr√©er table `company`
2. ‚úÖ Ajouter `company_id` partout
3. ‚úÖ Migrer les donn√©es existantes

### **Phase 2 : Entit√©s** üîÑ (En cours)
1. ‚úÖ Property modifi√©
2. ‚è≥ Tenant √† modifier
3. ‚è≥ Lease √† modifier
4. ‚è≥ User √† modifier
5. ‚è≥ Payment √† modifier
6. ‚è≥ Autres entit√©s

### **Phase 3 : Controllers** ‚è≥
1. ‚è≥ Cr√©er CompanyController
2. ‚è≥ Modifier PropertyController
3. ‚è≥ Modifier TenantController
4. ‚è≥ Modifier autres controllers

### **Phase 4 : Interface** ‚è≥
1. ‚è≥ Templates Company CRUD
2. ‚è≥ S√©lecteur de soci√©t√© dans les forms
3. ‚è≥ Filtres par soci√©t√© dans les listes
4. ‚è≥ Dashboard par soci√©t√©

### **Phase 5 : Tests** ‚è≥
1. ‚è≥ Tester cr√©ation organization ‚Üí company auto
2. ‚è≥ Tester filtrage par company pour managers
3. ‚è≥ Tester acc√®s global pour admins
4. ‚è≥ Tester isolation des donn√©es

---

## üéØ Commandes √† Ex√©cuter

```bash
# 1. Ex√©cuter la migration
php bin/console doctrine:migrations:migrate --no-interaction

# 2. Vider le cache
php bin/console cache:clear

# 3. Cr√©er les plans par d√©faut (si pas d√©j√† fait)
php bin/console app:create-default-plans

# 4. Tester l'inscription
# Aller sur /inscription/plans et cr√©er un compte
# V√©rifier qu'une Company est cr√©√©e automatiquement

# 5. Cr√©er un super admin si n√©cessaire
php bin/console app:create-super-admin
```

---

## ‚úÖ Avantages du Syst√®me Company

1. ‚úÖ **Multi-Sites** : G√©rer plusieurs agences/filiales
2. ‚úÖ **D√©l√©gation** : Assigner des gestionnaires par soci√©t√©
3. ‚úÖ **Isolation** : Donn√©es cloisonn√©es par soci√©t√©
4. ‚úÖ **Scalabilit√©** : Support des holdings et groupes
5. ‚úÖ **Reporting** : Stats globales ET par soci√©t√©
6. ‚úÖ **Professionnel** : Conforme aux besoins d'entreprise
7. ‚úÖ **Flexible** : Soci√©t√© unique OU multiples au choix

---

## üéâ R√©sultat Final

**Un syst√®me SaaS multi-tenant professionnel avec :**
- Organization (Compte client)
- Subscription (Abonnement)
- Company (Soci√©t√©s/Agences)
- Managers par Company
- Data isol√©e par Organization ET Company
- Features contr√¥l√©es par Plan
- Interface adapt√©e au r√¥le

**C'est une architecture d'entreprise compl√®te ! üè¢**

