# ‚úÖ Filtrage des documents par r√¥le utilisateur

## üéØ Objectif

Permettre aux locataires de voir uniquement leurs propres documents dans la section "Mes documents", tout en conservant l'acc√®s complet pour les administrateurs et gestionnaires.

---

## üîß Modifications apport√©es

### 1. **Contr√¥leur DocumentController**

**Fichier** : `src/Controller/DocumentController.php`

#### ‚úÖ M√©thode `index()` modifi√©e

**Avant** ‚ùå :
```php
public function index(DocumentRepository $documentRepository): Response
{
    // Organiser les documents par type
    $documentsByType = [
        'Assurance' => $documentRepository->findByType('Assurance'),
        'Avis d\'√©ch√©ance' => $documentRepository->findByType('Avis d\'√©ch√©ance'),
        'Bail' => array_merge(
            $documentRepository->findByType('Bail'),
            $documentRepository->findByType('Contrat de location')
        ),
        'Diagnostics' => $documentRepository->findByType('Diagnostics'),
        'OK' => $documentRepository->findByType('Conseils'),
    ];
    // ...
}
```

**Maintenant** ‚úÖ :
```php
public function index(DocumentRepository $documentRepository): Response
{
    $user = $this->getUser();
    
    // Initialiser toutes les cat√©gories
    $documentsByType = [
        'Assurance' => [],
        'Avis d\'√©ch√©ance' => [],
        'Bail' => [],
        'Diagnostics' => [],
        'OK' => [],
    ];

    // Filtrer les documents selon le r√¥le de l'utilisateur
    if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
        // Si l'utilisateur est un locataire, ne montrer que ses documents
        $tenant = $user->getTenant();
        if ($tenant) {
            $tenantDocuments = $documentRepository->findByTenant($tenant->getId());
            
            // Organiser par type
            foreach ($tenantDocuments as $document) {
                $type = $document->getType();
                
                // Grouper "Bail" et "Contrat de location" ensemble
                if ($type === 'Bail' || $type === 'Contrat de location') {
                    $type = 'Bail';
                }
                // Grouper "Conseils" sous "OK"
                elseif ($type === 'Conseils') {
                    $type = 'OK';
                }
                
                if (isset($documentsByType[$type])) {
                    $documentsByType[$type][] = $document;
                }
            }
        }
    } else {
        // Pour les admins/managers, remplir avec tous les documents
        $documentsByType['Assurance'] = $documentRepository->findByType('Assurance');
        $documentsByType['Avis d\'√©ch√©ance'] = $documentRepository->findByType('Avis d\'√©ch√©ance');
        $documentsByType['Bail'] = array_merge(
            $documentRepository->findByType('Bail'),
            $documentRepository->findByType('Contrat de location')
        );
        $documentsByType['Diagnostics'] = $documentRepository->findByType('Diagnostics');
        $documentsByType['OK'] = $documentRepository->findByType('Conseils');
    }
    
    // Calculer les statistiques (filtr√©es selon le r√¥le)
    $stats = $this->calculateFilteredStats($documentRepository, $user);

    return $this->render('document/index.html.twig', [
        'documents_by_type' => $documentsByType,
        'stats' => $stats,
        'is_tenant_view' => $user && in_array('ROLE_TENANT', $user->getRoles()),
    ]);
}
```

#### ‚úÖ M√©thode `byType()` modifi√©e

```php
public function byType(string $type, DocumentRepository $documentRepository): Response
{
    $user = $this->getUser();
    $documents = [];

    // Filtrer selon le r√¥le
    if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
        // Pour les locataires, filtrer par type ET par tenant
        $tenant = $user->getTenant();
        if ($tenant) {
            $allDocuments = $documentRepository->findByTenant($tenant->getId());
            foreach ($allDocuments as $document) {
                $documentType = $document->getType();
                // Grouper "Bail" et "Contrat de location"
                if (($documentType === 'Bail' || $documentType === 'Contrat de location') && $type === 'Bail') {
                    $documents[] = $document;
                } elseif ($documentType === $type) {
                    $documents[] = $document;
                }
            }
        }
    } else {
        // Pour les admins/managers, montrer tous les documents du type
        if ($type === 'Bail') {
            $documents = array_merge(
                $documentRepository->findByType('Bail'),
                $documentRepository->findByType('Contrat de location')
            );
        } else {
            $documents = $documentRepository->findByType($type);
        }
    }

    return $this->render('document/by_type.html.twig', [
        'documents' => $documents,
        'type' => $type,
    ]);
}
```

#### ‚úÖ M√©thode `search()` modifi√©e

```php
public function search(Request $request, DocumentRepository $documentRepository): Response
{
    $query = $request->query->get('q', '');
    $documents = [];
    $user = $this->getUser();

    if ($query) {
        if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
            // Pour les locataires, filtrer par tenant ET par recherche
            $tenant = $user->getTenant();
            if ($tenant) {
                $allDocuments = $documentRepository->findByTenant($tenant->getId());
                foreach ($allDocuments as $document) {
                    if (stripos($document->getName(), $query) !== false ||
                        stripos($document->getOriginalFileName(), $query) !== false ||
                        stripos($document->getDescription(), $query) !== false) {
                        $documents[] = $document;
                    }
                }
            }
        } else {
            // Pour les admins/managers, recherche globale
            $documents = $documentRepository->search($query);
        }
    }

    return $this->render('document/search.html.twig', [
        'documents' => $documents,
        'query' => $query,
    ]);
}
```

#### ‚úÖ M√©thode `expiring()` modifi√©e

```php
public function expiring(DocumentRepository $documentRepository): Response
{
    $user = $this->getUser();
    $expiringSoon = [];
    $expired = [];

    if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
        // Pour les locataires, filtrer par tenant
        $tenant = $user->getTenant();
        if ($tenant) {
            $allDocuments = $documentRepository->findByTenant($tenant->getId());
            $now = new \DateTime();
            $in30Days = new \DateTime('+30 days');

            foreach ($allDocuments as $document) {
                $expirationDate = $document->getExpirationDate();
                if ($expirationDate) {
                    if ($expirationDate <= $in30Days && $expirationDate > $now) {
                        $expiringSoon[] = $document;
                    } elseif ($expirationDate <= $now) {
                        $expired[] = $document;
                    }
                }
            }
        }
    } else {
        // Pour les admins/managers, montrer tous les documents
        $expiringSoon = $documentRepository->findExpiringSoon();
        $expired = $documentRepository->findExpired();
    }

    return $this->render('document/expiring.html.twig', [
        'expiring_soon' => $expiringSoon,
        'expired' => $expired,
    ]);
}
```

#### ‚úÖ Nouvelle m√©thode `calculateFilteredStats()`

```php
private function calculateFilteredStats(DocumentRepository $documentRepository, $user): array
{
    if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
        // Pour les locataires, calculer les stats sur leurs documents seulement
        $tenant = $user->getTenant();
        if ($tenant) {
            $tenantDocuments = $documentRepository->findByTenant($tenant->getId());
            
            $stats = [
                'total' => count($tenantDocuments),
                'archived' => 0,
                'expiring_soon' => 0,
                'expired' => 0
            ];

            foreach ($tenantDocuments as $document) {
                if ($document->isArchived()) {
                    $stats['archived']++;
                }
                
                $expirationDate = $document->getExpirationDate();
                if ($expirationDate) {
                    $now = new \DateTime();
                    $in30Days = new \DateTime('+30 days');
                    
                    if ($expirationDate <= $in30Days && $expirationDate > $now) {
                        $stats['expiring_soon']++;
                    } elseif ($expirationDate <= $now) {
                        $stats['expired']++;
                    }
                }
            }
            
            return $stats;
        }
    }

    // Pour les admins/managers, retourner les stats globales
    return $documentRepository->getStatistics();
}
```

---

## üéØ Fonctionnalit√©s impl√©ment√©es

### ‚úÖ Pour les Locataires (ROLE_TENANT)

1. **Documents filtr√©s** : Ne voient que leurs propres documents
2. **Statistiques personnalis√©es** : Compteurs bas√©s sur leurs documents uniquement
3. **Recherche filtr√©e** : Recherche uniquement dans leurs documents
4. **Documents expir√©s** : Seulement leurs documents qui expirent
5. **Navigation par type** : Acc√®s aux documents group√©s par cat√©gorie

### ‚úÖ Pour les Admins/Managers

1. **Vue globale** : Acc√®s √† tous les documents du syst√®me
2. **Statistiques globales** : Compteurs de tous les documents
3. **Recherche globale** : Recherche dans tous les documents
4. **Gestion compl√®te** : Acc√®s √† tous les documents expir√©s

---

## üîç Logique de filtrage

### Identification du r√¥le

```php
if ($user && in_array('ROLE_TENANT', $user->getRoles())) {
    // Logique pour les locataires
} else {
    // Logique pour les admins/managers
}
```

### R√©cup√©ration du tenant

```php
$tenant = $user->getTenant();
if ($tenant) {
    $tenantDocuments = $documentRepository->findByTenant($tenant->getId());
}
```

### Groupement des types

- **"Bail"** + **"Contrat de location"** ‚Üí **"Bail"**
- **"Conseils"** ‚Üí **"OK"**
- Autres types conserv√©s tels quels

---

## üéä R√©sultat

**Le filtrage des documents par r√¥le est maintenant fonctionnel !**

### Avantages

‚úÖ **S√©curit√©** : Les locataires ne voient que leurs documents  
‚úÖ **Performance** : Requ√™tes optimis√©es selon le r√¥le  
‚úÖ **UX** : Interface adapt√©e au r√¥le de l'utilisateur  
‚úÖ **Statistiques** : Compteurs personnalis√©s par r√¥le  
‚úÖ **Recherche** : Filtrage automatique selon le r√¥le  

### Tests √† effectuer

1. **Connexion locataire** ‚Üí V√©rifier que seuls ses documents apparaissent
2. **Connexion admin** ‚Üí V√©rifier l'acc√®s √† tous les documents
3. **Recherche locataire** ‚Üí V√©rifier le filtrage par tenant
4. **Statistiques** ‚Üí V√©rifier les compteurs personnalis√©s

---

**üìÖ Date** : 12 Octobre 2025  
**‚ú® Statut** : ‚úÖ Impl√©mentation termin√©e  
**üéØ Impact** : Filtrage s√©curis√© des documents par r√¥le
