# Configuration Apache Complète pour MYLOCCA - Environnements de Démo
# Fichier : C:/wamp64/bin/apache/apache2.4.54/conf/extra/mylocca-demo.conf

# =============================================================================
# CONFIGURATION PRINCIPALE MYLOCCA
# =============================================================================

# Site principal MYLOCCA
<VirtualHost *:80>
    ServerName mylocca.local
    ServerAlias www.mylocca.local
    DocumentRoot "C:/wamp64/mylocca/public"

    <Directory "C:/wamp64/mylocca/public">
        AllowOverride All
        Require all granted

        # Configuration Symfony
        DirectoryIndex index.php

        # Gestion des erreurs Symfony
        ErrorDocument 404 /index.php
    </Directory>

    # Variables d'environnement
    SetEnv APP_ENV prod
    SetEnv APP_DEBUG 0

    # Logs spécifiques MYLOCCA
    ErrorLog "C:/wamp64/logs/mylocca_error.log"
    CustomLog "C:/wamp64/logs/mylocca_access.log" combined

    # Headers de sécurité
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>

# =============================================================================
# CONFIGURATION ENVIRONNEMENTS DE DÉMO
# =============================================================================

# Configuration générique pour tous les sous-domaines de démo
<VirtualHost *:80>
    ServerName demo.mylocca.local
    ServerAlias *.demo.mylocca.local

    DocumentRoot "C:/wamp64/mylocca/public"

    <Directory "C:/wamp64/mylocca/public">
        AllowOverride All
        Require all granted

        # Configuration Symfony
        DirectoryIndex index.php

        # Gestion des erreurs Symfony
        ErrorDocument 404 /index.php
    </Directory>

    # Variables d'environnement pour les démos
    SetEnv APP_ENV demo
    SetEnv APP_DEBUG 1

    # Détection du sous-domaine
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^([^.]+)\.demo\.mylocca\.local$ [NC]
    RewriteRule ^(.*)$ - [E=DEMO_SUBDOMAIN:%1]

    # Logs spécifiques aux démos
    ErrorLog "C:/wamp64/logs/demo_error.log"
    CustomLog "C:/wamp64/logs/demo_access.log" combined

    # Headers de sécurité
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Headers spécifiques aux démos
    Header always set X-Demo-Environment "true"
</VirtualHost>

# =============================================================================
# CONFIGURATION SSL (Optionnel)
# =============================================================================

# Site principal MYLOCCA avec SSL
<VirtualHost *:443>
    ServerName mylocca.local
    ServerAlias www.mylocca.local
    DocumentRoot "C:/wamp64/mylocca/public"

    # Configuration SSL (à adapter selon votre certificat)
    SSLEngine on
    SSLCertificateFile "C:/wamp64/bin/apache/apache2.4.54/conf/ssl.crt/server.crt"
    SSLCertificateKeyFile "C:/wamp64/bin/apache/apache2.4.54/conf/ssl.key/server.key"

    <Directory "C:/wamp64/mylocca/public">
        AllowOverride All
        Require all granted

        # Configuration Symfony
        DirectoryIndex index.php

        # Gestion des erreurs Symfony
        ErrorDocument 404 /index.php
    </Directory>

    # Variables d'environnement
    SetEnv APP_ENV prod
    SetEnv APP_DEBUG 0

    # Logs spécifiques MYLOCCA SSL
    ErrorLog "C:/wamp64/logs/mylocca_ssl_error.log"
    CustomLog "C:/wamp64/logs/mylocca_ssl_access.log" combined

    # Headers de sécurité SSL
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>

# Environnements de démo avec SSL
<VirtualHost *:443>
    ServerName demo.mylocca.local
    ServerAlias *.demo.mylocca.local
    DocumentRoot "C:/wamp64/mylocca/public"

    # Configuration SSL (à adapter selon votre certificat)
    SSLEngine on
    SSLCertificateFile "C:/wamp64/bin/apache/apache2.4.54/conf/ssl.crt/server.crt"
    SSLCertificateKeyFile "C:/wamp64/bin/apache/apache2.4.54/conf/ssl.key/server.key"

    <Directory "C:/wamp64/mylocca/public">
        AllowOverride All
        Require all granted

        # Configuration Symfony
        DirectoryIndex index.php

        # Gestion des erreurs Symfony
        ErrorDocument 404 /index.php
    </Directory>

    # Variables d'environnement pour les démos SSL
    SetEnv APP_ENV demo
    SetEnv APP_DEBUG 1

    # Détection du sous-domaine
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^([^.]+)\.demo\.mylocca\.local$ [NC]
    RewriteRule ^(.*)$ - [E=DEMO_SUBDOMAIN:%1]

    # Logs spécifiques aux démos SSL
    ErrorLog "C:/wamp64/logs/demo_ssl_error.log"
    CustomLog "C:/wamp64/logs/demo_ssl_access.log" combined

    # Headers de sécurité SSL
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Headers spécifiques aux démos SSL
    Header always set X-Demo-Environment "true"
</VirtualHost>

# =============================================================================
# CONFIGURATION REDIRECTIONS
# =============================================================================

# Redirection HTTP vers HTTPS (Optionnel)
<VirtualHost *:80>
    ServerName mylocca.local
    ServerAlias www.mylocca.local
    Redirect permanent / https://mylocca.local/
</VirtualHost>

<VirtualHost *:80>
    ServerName demo.mylocca.local
    ServerAlias *.demo.mylocca.local
    Redirect permanent / https://demo.mylocca.local/
</VirtualHost>

# =============================================================================
# CONFIGURATION SPÉCIFIQUE PAR SOUS-DOMAINES (Générée automatiquement)
# =============================================================================

# Exemple de configuration générée automatiquement par DemoEnvironmentService
# Ces configurations sont créées dans conf/extra/{subdomain}.conf

# <VirtualHost *:80>
#     ServerName jean-dupont-a1b2.demo.mylocca.local
#     DocumentRoot "C:/wamp64/mylocca/public"
#
#     <Directory "C:/wamp64/mylocca/public">
#         AllowOverride All
#         Require all granted
#     </Directory>
#
#     # Configuration spécifique pour l'environnement de démo
#     SetEnv APP_ENV demo
#     SetEnv DEMO_SUBDOMAIN jean-dupont-a1b2
#
#     # Logs spécifiques
#     ErrorLog "C:/wamp64/logs/jean-dupont-a1b2_error.log"
#     CustomLog "C:/wamp64/logs/jean-dupont-a1b2_access.log" combined
# </VirtualHost>

# =============================================================================
# CONFIGURATION PERFORMANCE ET SÉCURITÉ
# =============================================================================

# Configuration générale pour tous les VirtualHosts MYLOCCA
<Directory "C:/wamp64/mylocca/public">
    # Sécurité
    Options -Indexes -ExecCGI
    AllowOverride All

    # Performance
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
    </IfModule>

    # Headers de sécurité communs
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Protection contre les attaques
    <IfModule mod_rewrite.c>
        RewriteEngine On

        # Bloquer les tentatives d'accès aux fichiers sensibles
        RewriteCond %{REQUEST_URI} \.(env|log|sql|bak|backup)$ [NC]
        RewriteRule ^(.*)$ - [F,L]

        # Bloquer les tentatives d'injection
        RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
        RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
        RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
        RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|ê|"|;|\?|\*|=$).* [NC,OR]
        RewriteCond %{QUERY_STRING} (NULL|OUTFILE|LOAD_FILE) [OR]
        RewriteCond %{QUERY_STRING} (\./|\../|\.../)+(motd|etc|bin) [NC,OR]
        RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
        RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC]
        RewriteRule ^(.*)$ - [F,L]
    </IfModule>
</Directory>

# =============================================================================
# CONFIGURATION LOGS
# =============================================================================

# Format de logs personnalisé pour MYLOCCA
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" mylocca_format

# Rotation des logs (à configurer avec logrotate ou similaire)
# Les logs sont stockés dans C:/wamp64/logs/

# =============================================================================
# CONFIGURATION MODULES REQUIS
# =============================================================================

# Modules Apache requis pour MYLOCCA :
# - mod_rewrite (pour les URLs Symfony)
# - mod_headers (pour les headers de sécurité)
# - mod_deflate (pour la compression)
# - mod_expires (pour la mise en cache)
# - mod_ssl (pour HTTPS)

# Vérifiez que ces modules sont activés :
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule headers_module modules/mod_headers.so
# LoadModule deflate_module modules/mod_deflate.so
# LoadModule expires_module modules/mod_expires.so
# LoadModule ssl_module modules/mod_ssl.so

# =============================================================================
# INSTRUCTIONS D'INSTALLATION
# =============================================================================

# 1. Copiez ce fichier dans : C:/wamp64/bin/apache/apache2.4.54/conf/extra/mylocca-demo.conf
# 2. Ajoutez dans httpd.conf : Include conf/extra/mylocca-demo.conf
# 3. Ajoutez dans hosts Windows : 127.0.0.1 mylocca.local demo.mylocca.local *.demo.mylocca.local
# 4. Redémarrez Apache
# 5. Testez avec : http://mylocca.local et http://demo.mylocca.local

# =============================================================================
# NOTES IMPORTANTES
# =============================================================================

# - Adaptez les chemins selon votre installation WAMP
# - Configurez les certificats SSL selon vos besoins
# - Les sous-domaines de démo sont générés automatiquement par DemoEnvironmentService
# - Les logs sont séparés pour faciliter le debugging
# - La configuration est optimisée pour Symfony 6+
# - Les headers de sécurité sont configurés selon les bonnes pratiques
