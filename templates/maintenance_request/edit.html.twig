{% extends 'base.html.twig' %}

{% block title %}Modifier la demande - LOKAPRO{% endblock %}

{% block page_title %}
    <h5 class="mb-0">
        <i class="bi bi-pencil-square me-2"></i>
        Modifier la demande de maintenance
    </h5>
{% endblock %}

{% block page_actions %}
    <a href="{{ path('app_maintenance_request_show', {id: maintenance_request.id}) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Retour
    </a>
{% endblock %}

{% block body %}
    <!-- Informations de la demande -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informations actuelles
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Demande :</strong><br>
                            {{ maintenance_request.title }}
                        </div>
                        <div class="col-md-3">
                            <strong>Statut :</strong><br>
                            <span class="badge bg-{{ maintenance_request.status == 'Ouverte' ? 'warning' : (maintenance_request.status == 'En cours' ? 'info' : 'success') }}">
                                {{ maintenance_request.status }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Priorité :</strong><br>
                            <span class="badge bg-{{ maintenance_request.priority == 'Élevée' ? 'danger' : (maintenance_request.priority == 'Moyenne' ? 'warning' : 'success') }}">
                                {{ maintenance_request.priority }}
                            </span>
                        </div>
                    </div>
                    {% if maintenance_request.property %}
                    <div class="mt-3">
                        <strong>Propriété :</strong><br>
                        <small class="text-muted">{{ maintenance_request.property.getFullAddress() }}</small>
                    </div>
                    {% endif %}
                    {% if maintenance_request.tenant %}
                    <div class="mt-2">
                        <strong>Locataire :</strong><br>
                        <small class="text-muted">{{ maintenance_request.tenant.fullName }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-calendar me-2"></i>
                        Dates
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Créée le :</strong><br>
                        <small>{{ maintenance_request.createdAt|date('d/m/Y H:i') }}</small>
                    </div>
                    {% if maintenance_request.requestedDate %}
                    <div class="mb-2">
                        <strong>Date souhaitée :</strong><br>
                        <small>{{ maintenance_request.requestedDate|date('d/m/Y') }}</small>
                    </div>
                    {% endif %}
                    {% if maintenance_request.updatedAt %}
                    <div>
                        <strong>Modifiée le :</strong><br>
                        <small>{{ maintenance_request.updatedAt|date('d/m/Y H:i') }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de modification -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-tools me-2"></i>
                        Modifier la demande
                    </h6>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.property) }}
                                    {{ form_widget(form.property, {'attr': {'class': 'form-select'}}) }}
                                    {{ form_errors(form.property) }}
                                </div>
                            </div>
                            {% if not is_tenant_view %}
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.tenant) }}
                                    {{ form_widget(form.tenant, {'attr': {'class': 'form-select'}}) }}
                                    {{ form_errors(form.tenant) }}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.title) }}
                            {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.title) }}
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.description) }}
                            {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                            {{ form_errors(form.description) }}
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form_label(form.category) }}
                                    {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                                    {{ form_errors(form.category) }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form_label(form.priority) }}
                                    {{ form_widget(form.priority, {'attr': {'class': 'form-select'}}) }}
                                    {{ form_errors(form.priority) }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form_label(form.status) }}
                                    {{ form_widget(form.status, {'attr': {'class': 'form-select'}}) }}
                                    {{ form_errors(form.status) }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form_label(form.requestedDate) }}
                                    {{ form_widget(form.requestedDate, {'attr': {'class': 'form-control'}}) }}
                                    {{ form_errors(form.requestedDate) }}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.notes) }}
                            {{ form_widget(form.notes, {'attr': {'class': 'form-control', 'rows': 3}}) }}
                            {{ form_errors(form.notes) }}
                        </div>

                        <!-- Informations supplémentaires pour l'édition -->
                        {% if maintenance_request.assignedTo %}
                        <div class="mb-3">
                            <label class="form-label">Assignée à</label>
                            <div class="form-control-plaintext">
                                {{ maintenance_request.assignedTo }}
                            </div>
                        </div>
                        {% endif %}

                        {% if maintenance_request.estimatedCost %}
                        <div class="mb-3">
                            <label class="form-label">Coût estimé</label>
                            <div class="form-control-plaintext">
                                {{ maintenance_request.estimatedCost|number_format(0, ',', ' ') }} XOF
                            </div>
                        </div>
                        {% endif %}

                        {% if maintenance_request.completedDate %}
                        <div class="mb-3">
                            <label class="form-label">Date de completion</label>
                            <div class="form-control-plaintext">
                                {{ maintenance_request.completedDate|date('d/m/Y') }}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ path('app_maintenance_request_show', {id: maintenance_request.id}) }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-2"></i>
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                Enregistrer les modifications
                            </button>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>

    <!-- Historique des modifications (si disponible) -->
    {% if maintenance_request.updatedAt and maintenance_request.updatedAt != maintenance_request.createdAt %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Historique
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">Demande créée</h6>
                                <p class="timeline-text">{{ maintenance_request.createdAt|date('d/m/Y à H:i') }}</p>
                            </div>
                        </div>
                        {% if maintenance_request.updatedAt != maintenance_request.createdAt %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">Dernière modification</h6>
                                <p class="timeline-text">{{ maintenance_request.updatedAt|date('d/m/Y à H:i') }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #dee2e6;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--bs-primary);
        }

        .timeline-title {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .timeline-text {
            margin: 0;
            font-size: 13px;
            color: #6c757d;
        }

        .form-control-plaintext {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
{% endblock %}
