{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - Gestion Immobilière{% endblock %}

{% block header %}
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h2 mb-0">
                    <i class="bi bi-speedometer2 text-primary"></i>
                    Tableau de bord
                </h1>
                <p class="text-muted mb-0">Vue d'ensemble de votre parc immobilier</p>
            </div>
            <div class="col-auto">
                <span class="text-muted">
                    <i class="bi bi-calendar3"></i>
                    {{ 'now'|date('d/m/Y H:i') }}
                </span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Statistiques principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Propriétés totales</div>
                        <div class="h3 mb-0 font-weight-bold">{{ propertyStats.total }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card success">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Revenus mensuels</div>
                        <div class="h3 mb-0 font-weight-bold">{{ contractStats.monthlyRevenue|number_format(0, ',', ' ') }} €</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cash-coin fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card warning">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Contrats actifs</div>
                        <div class="h3 mb-0 font-weight-bold">
                            {% for stat in contractStats.statusStats %}
                                {% if stat.status == 'active' %}{{ stat.count }}{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-file-earmark-text fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card {{ overduePayments|length > 0 ? 'danger' : 'success' }}">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Paiements en retard</div>
                        <div class="h3 mb-0 font-weight-bold">{{ overduePayments|length }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Graphique des revenus -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-graph-up"></i>
                        Évolution des revenus (6 derniers mois)
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Répartition des propriétés -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-pie-chart"></i>
                        Statut des propriétés
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="propertyStatusChart"></canvas>
                    <div class="mt-3">
                        {% for stat in propertyStats.statusStats %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">{{ stat.status|title }}</span>
                            <span class="badge bg-primary">{{ stat.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Alertes et notifications -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-bell"></i>
                        Alertes importantes
                    </h6>
                </div>
                <div class="card-body">
                    {% if expiringContracts|length > 0 %}
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i>
                            Contrats arrivant à échéance
                        </h6>
                        <p class="mb-2">{{ expiringContracts|length }} contrat(s) expirent dans les 30 prochains jours :</p>
                        <ul class="list-unstyled mb-0">
                            {% for contract in expiringContracts|slice(0, 3) %}
                            <li class="mb-1">
                                <strong>{{ contract.property.title }}</strong>
                                - {{ contract.tenant.fullName }}
                                <small class="text-muted">({{ contract.endDate|date('d/m/Y') }})</small>
                            </li>
                            {% endfor %}
                            {% if expiringContracts|length > 3 %}
                            <li><small><a href="{{ path('app_contract_expiring') }}">Voir tous...</a></small></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if urgentMaintenances|length > 0 %}
                    <div class="alert alert-danger" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-tools"></i>
                            Maintenances urgentes
                        </h6>
                        <p class="mb-2">{{ urgentMaintenances|length }} intervention(s) urgente(s) en attente :</p>
                        <ul class="list-unstyled mb-0">
                            {% for maintenance in urgentMaintenances|slice(0, 3) %}
                            <li class="mb-1">
                                <strong>{{ maintenance.title }}</strong>
                                - {{ maintenance.property.title }}
                                <small class="text-muted">({{ maintenance.reportedDate|date('d/m/Y') }})</small>
                            </li>
                            {% endfor %}
                            {% if urgentMaintenances|length > 3 %}
                            <li><small><a href="{{ path('app_maintenance_urgent') }}">Voir toutes...</a></small></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if overduePayments|length > 0 %}
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-credit-card"></i>
                            Paiements en retard
                        </h6>
                        <p class="mb-2">{{ overduePayments|length }} paiement(s) en retard :</p>
                        <ul class="list-unstyled mb-0">
                            {% for payment in overduePayments|slice(0, 3) %}
                            <li class="mb-1">
                                <strong>{{ payment.rentalContract.tenant.fullName }}</strong>
                                - {{ payment.amount }} € 
                                <small class="text-muted">(Échéance : {{ payment.dueDate|date('d/m/Y') }})</small>
                            </li>
                            {% endfor %}
                            {% if overduePayments|length > 3 %}
                            <li><small><a href="{{ path('app_payment_overdue') }}">Voir tous...</a></small></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if expiringContracts|length == 0 and urgentMaintenances|length == 0 and overduePayments|length == 0 %}
                    <div class="alert alert-success" role="alert">
                        <i class="bi bi-check-circle"></i>
                        Aucune alerte importante à signaler.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activités récentes -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clock-history"></i>
                        Activités récentes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for payment in recentPayments %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">Paiement reçu</h6>
                                <p class="timeline-text">
                                    {{ payment.rentalContract.tenant.fullName }} - {{ payment.amount }} €
                                    <small class="text-muted d-block">{{ payment.paymentDate|date('d/m/Y H:i') }}</small>
                                </p>
                            </div>
                        </div>
                        {% endfor %}

                        {% for maintenance in recentMaintenances %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{{ maintenance.priority == 'urgent' ? 'danger' : 'info' }}"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">Maintenance {{ maintenance.status == 'completed' ? 'terminée' : 'signalée' }}</h6>
                                <p class="timeline-text">
                                    {{ maintenance.title }} - {{ maintenance.property.title }}
                                    <small class="text-muted d-block">{{ maintenance.createdAt|date('d/m/Y H:i') }}</small>
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightning"></i>
                        Actions rapides
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{{ path('app_property_new') }}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-plus-circle"></i>
                                Nouvelle propriété
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ path('app_tenant_new') }}" class="btn btn-outline-success w-100">
                                <i class="bi bi-person-plus"></i>
                                Nouveau locataire
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ path('app_contract_new') }}" class="btn btn-outline-info w-100">
                                <i class="bi bi-file-plus"></i>
                                Nouveau contrat
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ path('app_maintenance_new') }}" class="btn btn-outline-warning w-100">
                                <i class="bi bi-tools"></i>
                                Nouvelle maintenance
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #e9ecef;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--bs-primary);
}

.timeline-title {
    margin-bottom: 5px;
    font-size: 0.9rem;
    color: var(--bs-dark);
}

.timeline-text {
    margin-bottom: 0;
    font-size: 0.85rem;
    color: var(--bs-secondary);
}
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique des revenus
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const monthlyRevenues = {{ monthlyRevenues|json_encode|raw }};
    
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: monthlyRevenues.map(r => r.label),
            datasets: [{
                label: 'Revenus (€)',
                data: monthlyRevenues.map(r => r.revenue),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('fr-FR', {
                                style: 'currency',
                                currency: 'EUR',
                                minimumFractionDigits: 0
                            }).format(value);
                        }
                    }
                }
            }
        }
    });

    // Graphique du statut des propriétés
    const propertyCtx = document.getElementById('propertyStatusChart').getContext('2d');
    const propertyStats = {{ propertyStats.statusStats|json_encode|raw }};
    
    new Chart(propertyCtx, {
        type: 'doughnut',
        data: {
            labels: propertyStats.map(s => s.status),
            datasets: [{
                data: propertyStats.map(s => s.count),
                backgroundColor: [
                    '#27ae60',
                    '#e74c3c',
                    '#f39c12',
                    '#3498db'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endblock %}