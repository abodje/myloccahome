{% extends 'base.html.twig' %}

{% block title %}Confidentialité - Mon Profil{% endblock %}

{% block page_title %}
    <h5 class="mb-0">
        <i class="bi bi-shield-lock me-2"></i>
        Confidentialité et Consentements
    </h5>
{% endblock %}

{% block page_actions %}
    <a href="{{ path('app_profile_index') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-2"></i> Retour au profil
    </a>
    <button type="submit" form="privacyForm" class="btn btn-primary btn-sm">
        <i class="bi bi-check-lg me-2"></i> Sauvegarder
    </button>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-lg-8">
        <form id="privacyForm" action="{{ path('app_profile_privacy') }}" method="POST">
            <!-- Gestion des données personnelles -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-person-gear me-2"></i>
                        Gestion des données personnelles
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Vos droits :</strong> Vous pouvez à tout moment modifier vos préférences de confidentialité et retirer votre consentement.
                    </div>

                    <!-- Communication Foncia -->
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-envelope me-2"></i>
                            Communications Foncia
                        </h6>
                        <p class="text-muted small">Recevez des informations sur nos services, offres promotionnelles et actualités.</p>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="foncia_communications"
                                   id="foncia_communications"
                                   {{ user.hasConsent('foncia_communications') ? 'checked' : '' }}>
                            <label class="form-check-label" for="foncia_communications">
                                <strong>J'accepte de recevoir des communications de Foncia</strong>
                                <small class="d-block text-muted">Emails, SMS, notifications push</small>
                            </label>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="foncia_no_communications"
                                   id="foncia_no_communications"
                                   {{ not user.hasConsent('foncia_communications') ? 'checked' : '' }}>
                            <label class="form-check-label" for="foncia_no_communications">
                                <strong>Je ne souhaite pas recevoir de communications de Foncia</strong>
                                <small class="d-block text-muted">Seules les communications essentielles seront conservées</small>
                            </label>
                        </div>
                    </div>

                    <!-- Communication Partenaires -->
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-handshake me-2"></i>
                            Communications Partenaires
                        </h6>
                        <p class="text-muted small">Recevez des offres de nos partenaires sélectionnés dans le secteur immobilier.</p>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="partner_communications"
                                   id="partner_communications"
                                   {{ user.hasConsent('partner_communications') ? 'checked' : '' }}>
                            <label class="form-check-label" for="partner_communications">
                                <strong>J'accepte de recevoir des communications de nos partenaires</strong>
                                <small class="d-block text-muted">Offres spéciales et services complémentaires</small>
                            </label>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="partner_no_communications"
                                   id="partner_no_communications"
                                   {{ not user.hasConsent('partner_communications') ? 'checked' : '' }}>
                            <label class="form-check-label" for="partner_no_communications">
                                <strong>Je ne souhaite pas recevoir de communications de nos partenaires</strong>
                                <small class="d-block text-muted">Vos données ne seront pas partagées avec nos partenaires</small>
                            </label>
                        </div>
                    </div>

                    <!-- Cookies et tracking -->
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-cookie me-2"></i>
                            Cookies et Analyse
                        </h6>
                        <p class="text-muted small">Nous utilisons des cookies pour améliorer votre expérience et analyser l'utilisation de notre site.</p>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="analytics_cookies"
                                   id="analytics_cookies"
                                   {{ user.hasConsent('analytics_cookies') ? 'checked' : '' }}>
                            <label class="form-check-label" for="analytics_cookies">
                                <strong>J'accepte les cookies d'analyse</strong>
                                <small class="d-block text-muted">Google Analytics et outils de mesure d'audience</small>
                            </label>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="marketing_cookies"
                                   id="marketing_cookies"
                                   {{ user.hasConsent('marketing_cookies') ? 'checked' : '' }}>
                            <label class="form-check-label" for="marketing_cookies">
                                <strong>J'accepte les cookies marketing</strong>
                                <small class="d-block text-muted">Publicité personnalisée et retargeting</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paramètres de sécurité -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        Paramètres de sécurité
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="two_factor_auth"
                                       id="two_factor_auth"
                                       {{ user.hasConsent('two_factor_auth') ? 'checked' : '' }}>
                                <label class="form-check-label" for="two_factor_auth">
                                    <strong>Authentification à deux facteurs</strong>
                                    <small class="d-block text-muted">SMS ou application d'authentification</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="login_notifications"
                                       id="login_notifications"
                                       {{ user.hasConsent('login_notifications') ? 'checked' : '' }}>
                                <label class="form-check-label" for="login_notifications">
                                    <strong>Notifications de connexion</strong>
                                    <small class="d-block text-muted">Email en cas de connexion depuis un nouvel appareil</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Données et export -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-download me-2"></i>
                        Vos données
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary" onclick="exportData()">
                                    <i class="bi bi-download me-2"></i>
                                    Exporter mes données
                                </button>
                                <small class="text-muted mt-2">Téléchargez une copie de toutes vos données personnelles</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-danger" onclick="deleteAccount()">
                                    <i class="bi bi-trash me-2"></i>
                                    Supprimer mon compte
                                </button>
                                <small class="text-muted mt-2">Cette action est irréversible</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token CSRF -->
            <input type="hidden" name="token" value="{{ csrf_token('profile_privacy') }}">
        </form>
    </div>

    <div class="col-lg-4">
        <!-- Résumé des paramètres -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-list-check me-2"></i>
                    Résumé de vos paramètres
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Communications Foncia
                        <span class="badge bg-{{ user.hasConsent('foncia_communications') ? 'success' : 'secondary' }}">
                            {{ user.hasConsent('foncia_communications') ? 'Activées' : 'Désactivées' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Communications Partenaires
                        <span class="badge bg-{{ user.hasConsent('partner_communications') ? 'success' : 'secondary' }}">
                            {{ user.hasConsent('partner_communications') ? 'Activées' : 'Désactivées' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Cookies d'analyse
                        <span class="badge bg-{{ user.hasConsent('analytics_cookies') ? 'success' : 'secondary' }}">
                            {{ user.hasConsent('analytics_cookies') ? 'Activés' : 'Désactivés' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Cookies marketing
                        <span class="badge bg-{{ user.hasConsent('marketing_cookies') ? 'success' : 'secondary' }}">
                            {{ user.hasConsent('marketing_cookies') ? 'Activés' : 'Désactivés' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Authentification 2FA
                        <span class="badge bg-{{ user.hasConsent('two_factor_auth') ? 'success' : 'secondary' }}">
                            {{ user.hasConsent('two_factor_auth') ? 'Activée' : 'Désactivée' }}
                        </span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Informations légales -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Informations légales
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    <strong>RGPD :</strong> Conformément au Règlement Général sur la Protection des Données,
                    vous disposez d'un droit d'accès, de rectification, de portabilité et d'effacement de vos données.
                </p>
                <p class="small text-muted">
                    <strong>Responsable du traitement :</strong> MYLOCCA<br>
                    <strong>Contact DPO :</strong> dpo@mylocca.com
                </p>
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-outline-secondary btn-sm" onclick="alert('Politique de confidentialité - En cours de développement')">
                        <i class="bi bi-file-text me-2"></i>
                        Politique de confidentialité
                    </a>
                    <a href="#" class="btn btn-outline-secondary btn-sm" onclick="alert('Politique des cookies - En cours de développement')">
                        <i class="bi bi-cookie me-2"></i>
                        Politique des cookies
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation pour la suppression du compte -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Attention !</strong> Cette action est irréversible.
                </div>
                <p>Tous vos données seront définitivement supprimées :</p>
                <ul>
                    <li>Vos informations personnelles</li>
                    <li>Vos propriétés et baux</li>
                    <li>Vos documents</li>
                    <li>Votre historique de paiements</li>
                </ul>
                <p class="text-muted">Si vous êtes sûr de vouloir continuer, tapez <strong>SUPPRIMER</strong> ci-dessous :</p>
                <input type="text" class="form-control" id="confirmDelete" placeholder="Tapez SUPPRIMER">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="bi bi-trash me-2"></i> Supprimer définitivement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// Gestion des switches mutuellement exclusifs
document.addEventListener('DOMContentLoaded', function() {
    // Foncia communications
    const fonciaYes = document.getElementById('foncia_communications');
    const fonciaNo = document.getElementById('foncia_no_communications');

    fonciaYes.addEventListener('change', function() {
        if (this.checked) {
            fonciaNo.checked = false;
        }
    });

    fonciaNo.addEventListener('change', function() {
        if (this.checked) {
            fonciaYes.checked = false;
        }
    });

    // Partner communications
    const partnerYes = document.getElementById('partner_communications');
    const partnerNo = document.getElementById('partner_no_communications');

    partnerYes.addEventListener('change', function() {
        if (this.checked) {
            partnerNo.checked = false;
        }
    });

    partnerNo.addEventListener('change', function() {
        if (this.checked) {
            partnerYes.checked = false;
        }
    });

    // Confirmation suppression compte
    const confirmInput = document.getElementById('confirmDelete');
    const confirmBtn = document.getElementById('confirmDeleteBtn');

    confirmInput.addEventListener('input', function() {
        confirmBtn.disabled = this.value !== 'SUPPRIMER';
    });
});

function exportData() {
    // Fonction pour exporter les données utilisateur
    if (confirm('Voulez-vous télécharger une copie de vos données personnelles ?')) {
        fetch('/profile/export-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mes-donnees-personnelles-' + new Date().toISOString().split('T')[0] + '.zip';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Erreur lors de l\'export des données : ' + error.message);
        });
    }
}

function deleteAccount() {
    new bootstrap.Modal(document.getElementById('deleteAccountModal')).show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (confirm('Êtes-vous absolument sûr de vouloir supprimer votre compte ? Cette action est irréversible !')) {
        // Rediriger vers la page de suppression
        window.location.href = '/profile/delete-account';
    }
});
</script>
{% endblock %}
