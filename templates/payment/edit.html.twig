{% extends 'base.html.twig' %}

{% block title %}Modifier Paiement #{{ payment.id }}{% endblock %}

{% block body %}
<div class="p-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-pencil me-2"></i>
            Modifier Paiement #{{ payment.id }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ path('app_payment_show', {id: payment.id}) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Retour
                </a>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Modification du paiement</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="row">
                    <!-- Informations non modifiables -->
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Contrat et locataire <small>(non modifiable)</small></h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Contrat de location</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                                <strong>{{ payment.rentalContract.property.title }}</strong>
                                <br>
                                <small class="text-muted">{{ payment.rentalContract.property.city }}</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Locataire</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                        {{ payment.tenant.firstName|first|upper }}{{ payment.tenant.lastName|first|upper }}
                                    </div>
                                    <div>
                                        <strong>{{ payment.tenant.fullName }}</strong>
                                        <br>
                                        <small class="text-muted">{{ payment.tenant.email }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="type" class="form-label">Type de paiement *</label>
                                    <select class="form-select" id="type" name="type" required>
                                        <option value="rent" {{ payment.type == 'rent' ? 'selected' : '' }}>Loyer</option>
                                        <option value="charges" {{ payment.type == 'charges' ? 'selected' : '' }}>Charges</option>
                                        <option value="deposit" {{ payment.type == 'deposit' ? 'selected' : '' }}>Dépôt de garantie</option>
                                        <option value="fees" {{ payment.type == 'fees' ? 'selected' : '' }}>Frais divers</option>
                                        <option value="other" {{ payment.type == 'other' ? 'selected' : '' }}>Autre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label">Montant (€) *</label>
                                    <input type="number" class="form-control" id="amount" name="amount" value="{{ payment.amount }}" step="0.01" required min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dates et statut -->
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Échéance et statut</h6>
                        
                        <div class="mb-3">
                            <label for="due_date" class="form-label">Date d'échéance *</label>
                            <input type="date" class="form-control" id="due_date" name="due_date" value="{{ payment.dueDate|date('Y-m-d') }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="status" class="form-label">Statut *</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="pending" {{ payment.status == 'pending' ? 'selected' : '' }}>En attente</option>
                                <option value="paid" {{ payment.status == 'paid' ? 'selected' : '' }}>Payé</option>
                                <option value="overdue" {{ payment.status == 'overdue' ? 'selected' : '' }}>En retard</option>
                            </select>
                        </div>

                        <div id="payment-details" style="{{ payment.status == 'paid' ? 'display: block;' : 'display: none;' }}">
                            <h6 class="text-muted mb-3">Détails du paiement</h6>
                            
                            <div class="mb-3">
                                <label for="paid_date" class="form-label">Date de paiement</label>
                                <input type="date" class="form-control" id="paid_date" name="paid_date" value="{{ payment.paidDate ? payment.paidDate|date('Y-m-d') : '' }}">
                            </div>

                            <div class="mb-3">
                                <label for="payment_method" class="form-label">Mode de paiement</label>
                                <select class="form-select" id="payment_method" name="payment_method">
                                    <option value="">Choisir</option>
                                    <option value="virement" {{ payment.paymentMethod == 'virement' ? 'selected' : '' }}>Virement</option>
                                    <option value="cheque" {{ payment.paymentMethod == 'cheque' ? 'selected' : '' }}>Chèque</option>
                                    <option value="especes" {{ payment.paymentMethod == 'especes' ? 'selected' : '' }}>Espèces</option>
                                    <option value="prelevement" {{ payment.paymentMethod == 'prelevement' ? 'selected' : '' }}>Prélèvement</option>
                                    <option value="carte" {{ payment.paymentMethod == 'carte' ? 'selected' : '' }}>Carte bancaire</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="reference" class="form-label">Référence</label>
                                <input type="text" class="form-control" id="reference" name="reference" value="{{ payment.reference }}" placeholder="Numéro de chèque, référence virement...">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Notes</h6>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes internes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Notes supplémentaires sur ce paiement...">{{ payment.notes }}</textarea>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ path('app_payment_show', {id: payment.id}) }}" class="btn btn-secondary">Annuler</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informations supplémentaires -->
    <div class="card mt-4">
        <div class="card-header">
            <h6 class="mb-0">Informations</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <strong>Paiement créé :</strong> {{ payment.createdAt|date('d/m/Y à H:i') }}
                    </small>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">
                        <strong>Dernière modification :</strong> {{ payment.updatedAt|date('d/m/Y à H:i') }}
                    </small>
                </div>
            </div>
            
            {% if payment.status == 'paid' and payment.paidDate %}
            <hr>
            <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                Ce paiement a été marqué comme payé le {{ payment.paidDate|date('d/m/Y') }}
                {% if payment.paymentMethod %}
                    par {{ payment.paymentMethod }}
                {% endif %}
                {% if payment.reference %}
                    (réf: {{ payment.reference }})
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Afficher/masquer les détails de paiement selon le statut
document.getElementById('status').addEventListener('change', function() {
    const paymentDetails = document.getElementById('payment-details');
    if (this.value === 'paid') {
        paymentDetails.style.display = 'block';
        document.getElementById('paid_date').required = true;
    } else {
        paymentDetails.style.display = 'none';
        document.getElementById('paid_date').required = false;
        // Vider les champs si on change vers non-payé
        document.getElementById('paid_date').value = '';
        document.getElementById('payment_method').value = '';
        document.getElementById('reference').value = '';
    }
});

// Validation des dates
document.getElementById('paid_date').addEventListener('change', function() {
    const dueDate = new Date(document.getElementById('due_date').value);
    const paidDate = new Date(this.value);
    
    if (this.value && paidDate < dueDate) {
        const confirm = window.confirm('La date de paiement est antérieure à la date d\'échéance. Continuer ?');
        if (!confirm) {
            this.value = '';
        }
    }
});

// Auto-définir la date de paiement si on passe en "payé"
document.getElementById('status').addEventListener('change', function() {
    if (this.value === 'paid' && !document.getElementById('paid_date').value) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('paid_date').value = today;
    }
});
</script>
{% endblock %}