{% extends 'base.html.twig' %}

{% block title %}Recherche : {{ query }} - LOKAPRO{% endblock %}

{% block page_title %}
    <h5 class="mb-0">
        <i class="bi bi-search me-2"></i>
        Résultats de recherche
    </h5>
{% endblock %}

{% block page_actions %}
    <a href="{{ path('app_dashboard') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Retour
    </a>
{% endblock %}

{% block body %}
    <!-- Barre de recherche -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ path('app_search') }}">
                <div class="input-group input-group-lg">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           name="q"
                           class="form-control"
                           placeholder="Rechercher dans LOKAPRO..."
                           value="{{ query }}"
                           autofocus>
                    <button type="submit" class="btn btn-primary">
                        Rechercher
                    </button>
                </div>
                <div class="form-text mt-2">
                    <i class="bi bi-lightbulb"></i>
                    Recherche dans : Biens, Locataires, Baux, Paiements, Documents, Maintenances
                </div>
            </form>
        </div>
    </div>

    {% if query %}
        <!-- Statistiques -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>{{ stats.total }}</strong> résultat(s) trouvé(s) pour
                    <strong>"{{ query }}"</strong>
                </div>
            </div>
        </div>

        <!-- Résultats par type -->
        {% if stats.total > 0 %}
            {% if results.properties|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-building me-2"></i>
                            Biens ({{ results.properties|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for property in results.properties %}
                            <a href="{{ path('app_property_show', {id: property.id}) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ property.address }}</h6>
                                        <small class="text-muted">
                                            {{ property.type }} - {{ property.city }} {{ property.postalCode }}
                                        </small>
                                    </div>
                                    <span class="badge bg-{{ property.status == 'Occupé' ? 'primary' : 'info' }}">
                                        {{ property.status }}
                                    </span>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.tenants|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-person me-2"></i>
                            Locataires ({{ results.tenants|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for tenant in results.tenants %}
                            <a href="{{ path('app_tenant_show', {id: tenant.id}) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                         style="width: 40px; height: 40px;">
                                        {{ tenant.firstName|first }}{{ tenant.lastName|first }}
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{{ tenant.firstName }} {{ tenant.lastName }}</h6>
                                        <small class="text-muted">
                                            <i class="bi bi-envelope"></i> {{ tenant.email }}
                                            {% if tenant.phone %}
                                                <i class="bi bi-phone ms-2"></i> {{ tenant.phone }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.leases|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-file-text me-2"></i>
                            Baux ({{ results.leases|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for lease in results.leases %}
                            <a href="{{ path('app_lease_show', {id: lease.id}) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            Bail #{{ lease.id }}
                                            {% if lease.tenant %}
                                                - {{ lease.tenant.fullName }}
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">
                                            {% if lease.property %}
                                                {{ lease.property.address }}
                                            {% endif %}
                                            {% if lease.startDate and lease.endDate %}
                                                • {{ lease.startDate|date('d/m/Y') }} → {{ lease.endDate|date('d/m/Y') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="badge bg-{{ lease.status == 'Actif' ? 'success' : 'secondary' }}">
                                        {{ lease.status }}
                                    </span>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.payments|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0">
                            <i class="bi bi-cash me-2"></i>
                            Paiements ({{ results.payments|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for payment in results.payments %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ payment.amount|currency }}
                                            {% if payment.lease and payment.lease.tenant %}
                                                - {{ payment.lease.tenant.fullName }}
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">
                                            Échéance : {{ payment.dueDate|date('d/m/Y') }}
                                            {% if payment.paidDate %}
                                                • Payé le {{ payment.paidDate|date('d/m/Y') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="badge bg-{{ payment.status == 'Payé' ? 'success' : (payment.status == 'En retard' ? 'danger' : 'warning') }}">
                                        {{ payment.status }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.documents|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-file-earmark me-2"></i>
                            Documents ({{ results.documents|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for document in results.documents %}
                            <a href="{{ path('app_document_show', {id: document.id}) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-file-pdf fs-3 text-danger me-3"></i>
                                    <div>
                                        <h6 class="mb-1">{{ document.name }}</h6>
                                        <small class="text-muted">
                                            {{ document.type }}
                                            {% if document.documentDate %}
                                                • {{ document.documentDate|date('d/m/Y') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.maintenance|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-tools me-2"></i>
                            Demandes de Maintenance ({{ results.maintenance|length }})
                        </h6>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for maintenance in results.maintenance %}
                            <a href="{{ path('app_maintenance_request_show', {id: maintenance.id}) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ maintenance.description|slice(0, 60) }}...
                                        </h6>
                                        <small class="text-muted">
                                            {% if maintenance.property %}
                                                {{ maintenance.property.address }}
                                            {% endif %}
                                            • {{ maintenance.createdAt|date('d/m/Y') }}
                                        </small>
                                    </div>
                                    <span class="badge bg-{{ maintenance.status == 'Terminée' ? 'success' : (maintenance.status == 'En cours' ? 'warning' : 'danger') }}">
                                        {{ maintenance.status }}
                                    </span>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center p-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h5 class="mt-3 text-muted">Aucun résultat trouvé</h5>
                <p class="text-muted">Essayez avec d'autres mots-clés ou vérifiez l'orthographe</p>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

