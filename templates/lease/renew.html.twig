{% extends 'base.html.twig' %}

{% block title %}Renouveler le contrat - LOKAPRO{% endblock %}

{% block page_title %}
    <h5 class="mb-0">
        <i class="bi bi-arrow-repeat me-2"></i>
        Renouveler un contrat de location
    </h5>
{% endblock %}

{% block page_actions %}
    <a href="{{ path('app_lease_index') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Retour
    </a>
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Informations sur le renouvellement -->
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle me-2"></i>
                    Création d'un nouveau contrat
                </h6>
                <p class="mb-0">
                    Remplissez les informations ci-dessous pour créer le nouveau contrat de location.
                    Vous pouvez pré-remplir les champs avec les données d'un contrat existant si nécessaire.
                </p>
            </div>

            {% if old_lease is defined %}
                <!-- Informations du contrat actuel -->
                <div class="alert alert-light border mb-4">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>
                        Contrat actuel à renouveler
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Période :</strong> {{ old_lease.startDate|date('d/m/Y') }} au {{ old_lease.endDate|date('d/m/Y') }}<br>
                            <strong>Locataire :</strong> {{ old_lease.tenant.fullName }}<br>
                            <strong>Propriété :</strong> {{ old_lease.property.address }}
                        </div>
                        <div class="col-md-6">
                            <strong>Loyer :</strong> {{ old_lease.monthlyRent|number_format(0, ',', ' ') }} FCFA<br>
                            <strong>Charges :</strong> {{ old_lease.charges ? (old_lease.charges|number_format(0, ',', ' ') ~ ' FCFA') : 'Incluses' }}<br>
                            <strong>Statut :</strong> <span class="badge bg-info">{{ old_lease.status }}</span>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Formulaire de renouvellement -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-file-text me-2"></i>
                        Nouveau contrat de location
                    </h6>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Un nouveau contrat sera créé. {% if old_lease is defined %}Le contrat actuel sera automatiquement marqué comme "Terminé".{% endif %}
                        </div>

                        <!-- Propriété et locataire -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.property) }}
                                    {{ form_widget(form.property) }}
                                    {{ form_errors(form.property) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.tenant) }}
                                    {{ form_widget(form.tenant) }}
                                    {{ form_errors(form.tenant) }}
                                </div>
                            </div>
                        </div>

                        <!-- Période -->
                        <h6 class="mt-3 mb-3">Période du nouveau contrat</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.startDate, 'Date de début') }}
                                    {{ form_widget(form.startDate) }}
                                    {{ form_errors(form.startDate) }}
                                    {% if old_lease is defined %}
                                        <small class="text-muted">Ancienne fin : {{ old_lease.endDate|date('d/m/Y') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.endDate, 'Date de fin') }}
                                    {{ form_widget(form.endDate) }}
                                    {{ form_errors(form.endDate) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.status) }}
                                    {{ form_widget(form.status) }}
                                    {{ form_errors(form.status) }}
                                </div>
                            </div>
                        </div>

                        <!-- Conditions financières -->
                        <h6 class="mt-4 mb-3">Conditions financières</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.monthlyRent) }}
                                    {{ form_widget(form.monthlyRent) }}
                                    {{ form_errors(form.monthlyRent) }}
                                    {% if old_lease is defined %}
                                        <small class="text-muted">Ancien : {{ old_lease.monthlyRent|number_format(0, ',', ' ') }} FCFA</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.charges) }}
                                    {{ form_widget(form.charges) }}
                                    {{ form_errors(form.charges) }}
                                    {% if old_lease is defined and old_lease.charges %}
                                        <small class="text-muted">Ancien : {{ old_lease.charges|number_format(0, ',', ' ') }} FCFA</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.deposit) }}
                                    {{ form_widget(form.deposit) }}
                                    {{ form_errors(form.deposit) }}
                                    {% if old_lease is defined and old_lease.deposit %}
                                        <small class="text-muted">Ancien : {{ old_lease.deposit|number_format(0, ',', ' ') }} FCFA</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.rentDueDay) }}
                            {{ form_widget(form.rentDueDay) }}
                            {{ form_errors(form.rentDueDay) }}
                        </div>

                        <!-- Conditions particulières -->
                        <div class="mb-3">
                            {{ form_label(form.terms, 'Conditions particulières (optionnel)') }}
                            {{ form_widget(form.terms) }}
                            {{ form_errors(form.terms) }}
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            {% if old_lease is defined %}
                                <a href="{{ path('app_lease_show', {id: old_lease.id}) }}" class="btn btn-secondary">Annuler</a>
                            {% else %}
                                <a href="{{ path('app_lease_index') }}" class="btn btn-secondary">Annuler</a>
                            {% endif %}
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-arrow-repeat me-2"></i>
                                Créer le nouveau contrat
                            </button>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Calculer automatiquement la date de fin (12 mois après le début)
            const startDateInput = document.getElementById('lease_startDate');
            const endDateInput = document.getElementById('lease_endDate');

            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', function() {
                    if (this.value) {
                        const startDate = new Date(this.value);
                        const endDate = new Date(startDate);
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setDate(endDate.getDate() - 1);

                        // Format YYYY-MM-DD
                        const year = endDate.getFullYear();
                        const month = String(endDate.getMonth() + 1).padStart(2, '0');
                        const day = String(endDate.getDate()).padStart(2, '0');

                        endDateInput.value = `${year}-${month}-${day}`;
                    }
                });
            }
        });
    </script>
{% endblock %}

