{% extends 'base.html.twig' %}

{% block title %}Redirection vers CinetPay - LOKAPRO{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-6">

            <!-- Page de redirection -->
            <div class="card text-center">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        Redirection vers CinetPay
                    </h5>
                </div>
                <div class="card-body">

                    <!-- Spinner de chargement -->
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>

                    <!-- Message -->
                    <h6 class="text-muted mb-3">Préparation de votre paiement</h6>
                    <p class="mb-4">
                        Vous allez être redirigé vers la plateforme de paiement sécurisée CinetPay
                        pour finaliser votre transaction.
                    </p>

                    <!-- Détails du paiement -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">Détails du paiement</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td><strong>Type :</strong></td>
                                    <td>{{ payment.type }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Montant :</strong></td>
                                    <td class="h5 text-primary">{{ payment.amount|currency }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Date d'échéance :</strong></td>
                                    <td>{{ payment.dueDate|date('d/m/Y') }}</td>
                                </tr>
                                {% if payment.lease and payment.lease.tenant %}
                                <tr>
                                    <td><strong>Locataire :</strong></td>
                                    <td>{{ payment.lease.tenant.fullName }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-lg" onclick="proceedToPayment()">
                            <i class="bi bi-credit-card me-2"></i>
                            Continuer vers CinetPay
                        </button>

                        <a href="{{ path('app_payment_index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>
                            Retour aux paiements
                        </a>
                    </div>

                    <!-- Informations de sécurité -->
                    <div class="mt-4">
                        <small class="text-muted">
                            <i class="bi bi-shield-check me-1"></i>
                            Paiement sécurisé SSL • Conformité PCI DSS
                        </small>
                    </div>

                </div>
            </div>

            <!-- Instructions -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        Instructions de paiement
                    </h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <i class="bi bi-1-circle text-primary me-2"></i>
                            Cliquez sur "Continuer vers CinetPay"
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-2-circle text-primary me-2"></i>
                            Choisissez votre moyen de paiement (Mobile Money ou Carte)
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-3-circle text-primary me-2"></i>
                            Suivez les instructions sur CinetPay
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-4-circle text-primary me-2"></i>
                            Vous serez automatiquement redirigé après le paiement
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- URL de paiement CinetPay (masquée) -->
<div id="paymentUrl" style="display: none;">{{ payment_url ?? '' }}</div>

<!-- Debug: Afficher l'URL en mode debug -->
{% if app.debug %}
<div class="alert alert-info mt-3">
    <strong>Debug:</strong> URL de paiement = "{{ payment_url ?? 'VIDE' }}"
    {% if error_message is defined and error_message %}
        <br><strong>Erreur:</strong> {{ error_message }}
    {% endif %}
</div>
{% endif %}

<!-- Message d'erreur si problème -->
{% if error_message is defined and error_message %}
<div class="alert alert-danger mt-3">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Erreur de paiement :</strong> {{ error_message }}
    <br><small class="text-muted">Veuillez vérifier votre configuration CinetPay dans les paramètres admin.</small>
</div>
{% endif %}

<script>
// Auto-redirection après 3 secondes seulement si payment_url existe
const paymentUrlElement = document.getElementById('paymentUrl');
const paymentUrl = paymentUrlElement ? paymentUrlElement.textContent.trim() : '';

if (paymentUrl && paymentUrl !== '' && paymentUrl !== 'VIDE') {
    // Ajouter le countdown seulement si on a une URL valide
    let countdown = 3;
    const countdownElement = document.createElement('div');
    countdownElement.className = 'mt-3 text-muted small';
    countdownElement.innerHTML = `Redirection automatique dans <span id="countdown">${countdown}</span> secondes...`;

    // Ajouter le countdown au bouton
    document.querySelector('.btn-success').parentNode.appendChild(countdownElement);

    const countdownInterval = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;

        if (countdown <= 0) {
            clearInterval(countdownInterval);
            proceedToPayment();
        }
    }, 1000);
} else {
    // Pas d'URL, désactiver le bouton et afficher un message
    const btn = document.querySelector('.btn-success');
    btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Erreur de configuration';
    btn.disabled = true;
    btn.className = 'btn btn-danger btn-lg';

    // Afficher un message d'erreur
    const errorMsg = document.createElement('div');
    errorMsg.className = 'alert alert-warning mt-3';
    errorMsg.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>URL de paiement non disponible. Veuillez réessayer.';
    btn.parentNode.appendChild(errorMsg);
}

function proceedToPayment() {
    const paymentUrlElement = document.getElementById('paymentUrl');
    const paymentUrl = paymentUrlElement ? paymentUrlElement.textContent.trim() : '';

    if (paymentUrl && paymentUrl !== '') {
        // Désactiver le bouton
        const btn = document.querySelector('.btn-success, .btn-danger');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Redirection...';
        }

        // Rediriger vers CinetPay
        console.log('Redirection vers CinetPay:', paymentUrl);
        window.location.href = paymentUrl;
    } else {
        // Si pas d'URL, rediriger vers la page de paiement
        console.log('Pas d\'URL de paiement, retour à la page de paiement');
        window.location.href = '{{ path("app_online_payment_tenant_page", {id: payment.id}) }}';
    }
}

// Arrêter le countdown si l'utilisateur clique manuellement
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.querySelector('.btn-success, .btn-danger');
    if (btn) {
        btn.addEventListener('click', () => {
            // Arrêter le countdown si il existe
            const countdownElement = document.querySelector('#countdown');
            if (countdownElement) {
                countdownElement.parentElement.style.display = 'none';
            }
        });
    }
});
</script>

{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
.spinner-border {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card-header.bg-primary {
    background-color: var(--bs-primary) !important;
}

.table-borderless td {
    border: none;
    padding: 0.25rem 0;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

.text-primary {
    color: var(--bs-primary) !important;
}

.list-unstyled li {
    padding: 0.25rem 0;
}
</style>
{% endblock %}
