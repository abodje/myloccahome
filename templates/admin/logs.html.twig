{% extends 'base.html.twig' %}

{% block title %}Logs système - Administration{% endblock %}

{% block page_title %}
    <h5 class="mb-0">
        <i class="bi bi-journal-text me-2"></i>
        Logs système
    </h5>
{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
            <i class="bi bi-arrow-clockwise"></i> Actualiser
        </button>
        <button type="button" class="btn btn-outline-success btn-sm" onclick="exportLogs()">
            <i class="bi bi-download"></i> Exporter
        </button>
    </div>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-12">
            <!-- Filtres -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Filtres
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="levelFilter" class="form-label">Niveau</label>
                            <select class="form-select" id="levelFilter">
                                <option value="">Tous les niveaux</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="DEBUG">DEBUG</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="contextFilter" class="form-label">Contexte</label>
                            <select class="form-select" id="contextFilter">
                                <option value="">Tous les contextes</option>
                                <option value="TenantController">TenantController</option>
                                <option value="PaymentController">PaymentController</option>
                                <option value="PropertyController">PropertyController</option>
                                <option value="AccountingService">AccountingService</option>
                                <option value="TaskManagerService">TaskManagerService</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dateFilter" class="form-label">Période</label>
                            <select class="form-select" id="dateFilter">
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                                <option value="all">Tout</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                    <i class="bi bi-search"></i> Filtrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-info-circle text-primary fs-1"></i>
                            <h5 class="card-title mt-2">{{ logs|filter(log => log.level == 'INFO')|length }}</h5>
                            <p class="card-text">INFO</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                            <h5 class="card-title mt-2">{{ logs|filter(log => log.level == 'WARNING')|length }}</h5>
                            <p class="card-text">WARNING</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-x-circle text-danger fs-1"></i>
                            <h5 class="card-title mt-2">{{ logs|filter(log => log.level == 'ERROR')|length }}</h5>
                            <p class="card-text">ERROR</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-bug text-secondary fs-1"></i>
                            <h5 class="card-title mt-2">{{ logs|filter(log => log.level == 'DEBUG')|length }}</h5>
                            <p class="card-text">DEBUG</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des logs -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Logs système ({{ logs|length }} résultats)
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Effacer filtres
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if logs|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 120px;">Date/Heure</th>
                                        <th style="width: 80px;">Niveau</th>
                                        <th style="width: 150px;">Contexte</th>
                                        <th>Message</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logs %}
                                        <tr class="log-row" data-level="{{ log.level }}" data-context="{{ log.context }}">
                                            <td>
                                                <small class="text-muted">
                                                    {{ log.timestamp|date('d/m/Y H:i:s') }}
                                                </small>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ log.level == 'ERROR' ? 'danger' : (log.level == 'WARNING' ? 'warning' : (log.level == 'DEBUG' ? 'secondary' : 'primary')) }}">
                                                    <i class="bi bi-{{ log.level == 'ERROR' ? 'x-circle' : (log.level == 'WARNING' ? 'exclamation-triangle' : (log.level == 'DEBUG' ? 'bug' : 'info-circle')) }}"></i>
                                                    {{ log.level }}
                                                </span>
                                            </td>
                                            <td>
                                                <code class="text-muted">{{ log.context }}</code>
                                            </td>
                                            <td>
                                                <div class="log-message">
                                                    {{ log.message }}
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="showLogDetails({{ loop.index }})" title="Voir les détails">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-journal-x text-muted fs-1"></i>
                            <h5 class="text-muted mt-3">Aucun log trouvé</h5>
                            <p class="text-muted">Aucun log ne correspond aux critères de recherche.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour les détails du log -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logDetailsModalLabel">
                        <i class="bi bi-info-circle me-2"></i>
                        Détails du log
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logDetailsContent">
                        <!-- Contenu chargé dynamiquement -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function refreshLogs() {
            location.reload();
        }

        function exportLogs() {
            // Simulation d'export - à implémenter selon les besoins
            alert('Fonction d\'export à implémenter');
        }

        function applyFilters() {
            const levelFilter = document.getElementById('levelFilter').value;
            const contextFilter = document.getElementById('contextFilter').value;

            const rows = document.querySelectorAll('.log-row');

            rows.forEach(row => {
                let show = true;

                if (levelFilter && row.dataset.level !== levelFilter) {
                    show = false;
                }

                if (contextFilter && row.dataset.context !== contextFilter) {
                    show = false;
                }

                row.style.display = show ? '' : 'none';
            });

            // Mettre à jour le compteur
            const visibleRows = document.querySelectorAll('.log-row[style=""], .log-row:not([style*="none"])');
            console.log(`${visibleRows.length} logs affichés sur {{ logs|length }}`);
        }

        function clearFilters() {
            document.getElementById('levelFilter').value = '';
            document.getElementById('contextFilter').value = '';
            document.getElementById('dateFilter').value = 'today';

            // Afficher tous les logs
            const rows = document.querySelectorAll('.log-row');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        function showLogDetails(index) {
            const log = {{ logs|json_encode|raw }};
            const logData = log[index - 1];

            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informations générales</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Niveau:</strong></td>
                                <td><span class="badge bg-${logData.level === 'ERROR' ? 'danger' : (logData.level === 'WARNING' ? 'warning' : (logData.level === 'DEBUG' ? 'secondary' : 'primary'))}">${logData.level}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Contexte:</strong></td>
                                <td><code>${logData.context}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Date:</strong></td>
                                <td>${new Date(logData.timestamp.date).toLocaleString('fr-FR')}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Message</h6>
                        <div class="alert alert-info">
                            ${logData.message}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('logDetailsContent').innerHTML = content;

            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
            modal.show();
        }

        // Appliquer les filtres au chargement si des paramètres sont présents
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const level = urlParams.get('level');
            const context = urlParams.get('context');

            if (level) {
                document.getElementById('levelFilter').value = level;
            }
            if (context) {
                document.getElementById('contextFilter').value = context;
            }

            if (level || context) {
                applyFilters();
            }
        });
    </script>
{% endblock %}
